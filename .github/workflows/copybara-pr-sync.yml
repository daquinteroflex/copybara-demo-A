name: Copybara PR Import from demo-B

on:
  # Run on schedule to check for new PRs
  # schedule:
  #   - cron: '*/30 * * * *'  # Every 30 minutes

  # Manual trigger with optional PR number
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Specific PR number to import from demo-B (leave empty to import all ready PRs)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (preview only, no changes)'
        required: false
        type: boolean
        default: false

  # Trigger on push to specific branch (for testing)
  push:
    branches:
      - copybara-pr-sync-test

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-token:
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.generate-token.outputs.token }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.COPYBARA_APP_ID }}
          private-key: ${{ secrets.COPYBARA_PRIVATE_KEY }}
          repositories: copybara-demo-A,copybara-demo-B

      - name: Export token as output
        id: generate-token
        run: echo "token=${{ steps.app-token.outputs.token }}" >> $GITHUB_OUTPUT

  import-prs:
    needs: generate-token
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/anipos/copybara-docker-image
    env:
      GH_TOKEN: ${{ needs.generate-token.outputs.token }}

    steps:
      - name: Checkout demo-A repo
        uses: actions/checkout@v4
        with:
          repository: daquinteroflex/copybara-demo-A
          fetch-depth: 0
          token: ${{ needs.generate-token.outputs.token }}
          sparse-checkout: |
            copy.bara.sky
            public/test_repo
            .gitignore
            .gitattributes
          sparse-checkout-cone-mode: false

      - name: Verify checkout
        run: |
          echo "=== Workspace contents ==="
          ls -la
          echo "=== copy.bara.sky exists ==="
          ls -la copy.bara.sky || echo "ERROR: copy.bara.sky not found"
          echo "=== public/test_repo contents ==="
          ls -la public/test_repo/ || echo "Directory not found"

      - name: Configure Git
        env:
          GITHUB_TOKEN: ${{ needs.generate-token.outputs.token }}
        run: |
          git config --global user.name "Copybara Bot"
          git config --global user.email "copybara@example.com"
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"

          # Configure git to use token for HTTPS
          git config --global credential.helper store
          echo "https://x-access-token:${GITHUB_TOKEN}@github.com" > ~/.git-credentials

      - name: Install GitHub CLI
        run: |
          echo "=== Installing GitHub CLI ==="
          # Install dependencies
          apt-get update
          apt-get install -y curl gnupg

          # Add GitHub CLI repository
          mkdir -p -m 755 /etc/apt/keyrings
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
          chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null

          # Install gh CLI
          apt-get update
          apt-get install -y gh

          # Verify installation
          gh --version

      - name: Run Copybara PR Import (Specific PR)
        if: inputs.pr_number != ''
        env:
          GITHUB_TOKEN: ${{ needs.generate-token.outputs.token }}
          PR_NUMBER: ${{ inputs.pr_number }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "=== Current working directory ==="
          pwd
          echo "=== Environment ==="
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE}"
          echo "PR_NUMBER=${PR_NUMBER}"
          echo "DRY_RUN=${DRY_RUN}"

          # Validate PR number
          if ! [[ "$PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "âŒ Invalid PR number: ${PR_NUMBER}"
            echo "### âŒ Invalid Input" >> $GITHUB_STEP_SUMMARY
            echo "PR number must be a positive integer, got: ${PR_NUMBER}" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "=== Verifying config file ==="
          cat "${GITHUB_WORKSPACE}/copy.bara.sky" | head -20

          echo "=== Running copybara for PR #${PR_NUMBER} ==="

          # Get the base branch commit for baseline (source)
          echo "=== Fetching baseline from demo-B main branch ==="
          SOURCE_BASELINE=$(gh api repos/daquinteroflex/copybara-demo-B/git/refs/heads/main --jq '.object.sha')
          echo "Source baseline commit: ${SOURCE_BASELINE}"

          # Get the parent commit from destination (demo-A main)
          echo "=== Fetching parent from demo-A main branch ==="
          DEST_PARENT=$(gh api repos/daquinteroflex/copybara-demo-A/git/refs/heads/main --jq '.object.sha')
          echo "Destination parent commit: ${DEST_PARENT}"

          # Build copybara command
          COPYBARA_CMD="copybara migrate \
            ${GITHUB_WORKSPACE}/copy.bara.sky \
            import_pr_from_b \
            ${PR_NUMBER} \
            --git-destination-url=\"https://x-access-token:${GITHUB_TOKEN}@github.com/daquinteroflex/copybara-demo-A.git\" \
            --baseline-for-merge-import=\"${SOURCE_BASELINE}\" \
            --change-request-parent=\"${DEST_PARENT}\" \
            --verbose"

          # Add dry-run flag if requested
          if [ "${DRY_RUN}" = "true" ]; then
            COPYBARA_CMD="${COPYBARA_CMD} --dry-run"
          fi

          echo "=== Executing command ==="
          echo "${COPYBARA_CMD}"
          eval "${COPYBARA_CMD}"

      - name: Run Copybara PR Import (All Ready PRs)
        if: inputs.pr_number == ''
        env:
          GITHUB_TOKEN: ${{ needs.generate-token.outputs.token }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "=== Current working directory ==="
          pwd
          echo "=== Checking for all ready PRs from demo-B ==="

          # Get list of open PRs from demo-B
          echo "=== Fetching open PRs from demo-B ==="
          if ! PR_LIST=$(gh pr list \
            --repo daquinteroflex/copybara-demo-B \
            --state open \
            --json number \
            --jq '.[].number' 2>&1); then
            echo "âŒ Failed to fetch PRs from demo-B"
            echo "Error: $PR_LIST"
            echo "### âŒ Failed to Fetch PRs" >> $GITHUB_STEP_SUMMARY
            echo "Could not retrieve open PRs from copybara-demo-B. Check authentication and repository access." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [ -z "$PR_LIST" ]; then
            echo "No open PRs found in demo-B"
            echo "### â„¹ï¸ No PRs to Import" >> $GITHUB_STEP_SUMMARY
            echo "No open PRs found in copybara-demo-B at this time." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "Found PRs: $PR_LIST"

          # Get the base branch commit for baseline (source)
          echo "=== Fetching baseline from demo-B main branch ==="
          SOURCE_BASELINE=$(gh api repos/daquinteroflex/copybara-demo-B/git/refs/heads/main --jq '.object.sha')
          echo "Source baseline commit: ${SOURCE_BASELINE}"

          # Get the parent commit from destination (demo-A main)
          echo "=== Fetching parent from demo-A main branch ==="
          DEST_PARENT=$(gh api repos/daquinteroflex/copybara-demo-A/git/refs/heads/main --jq '.object.sha')
          echo "Destination parent commit: ${DEST_PARENT}"

          # Import each PR
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          SKIPPED_COUNT=0

          for PR_NUM in $PR_LIST; do
            echo ""
            echo "=== Processing PR #${PR_NUM} ==="

            # Build copybara command for this PR
            COPYBARA_CMD="copybara migrate \
              ${GITHUB_WORKSPACE}/copy.bara.sky \
              import_pr_from_b \
              ${PR_NUM} \
              --git-destination-url=\"https://x-access-token:${GITHUB_TOKEN}@github.com/daquinteroflex/copybara-demo-A.git\" \
              --baseline-for-merge-import=\"${SOURCE_BASELINE}\" \
              --change-request-parent=\"${DEST_PARENT}\" \
              --verbose"

            # Add dry-run flag if requested
            if [ "${DRY_RUN}" = "true" ]; then
              COPYBARA_CMD="${COPYBARA_CMD} --dry-run"
            fi

            echo "Executing: ${COPYBARA_CMD}"

            # Run copybara for this PR and capture exit code
            eval "${COPYBARA_CMD}"
            EXIT_CODE=$?

            # Check result based on exit code
            if [ $EXIT_CODE -eq 0 ]; then
              echo "âœ… Successfully imported PR #${PR_NUM}"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            elif [ $EXIT_CODE -eq 4 ]; then
              echo "â­ï¸  PR #${PR_NUM} skipped (no changes or already imported)"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            else
              echo "âŒ Failed to import PR #${PR_NUM} (exit code: ${EXIT_CODE})"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done

          echo ""
          echo "=== Import Summary ==="
          echo "âœ… Success: ${SUCCESS_COUNT}"
          echo "â­ï¸  Skipped: ${SKIPPED_COUNT}"
          echo "âŒ Failed: ${FAIL_COUNT}"

          # Set outputs for later steps
          echo "SUCCESS_COUNT=${SUCCESS_COUNT}" >> $GITHUB_ENV
          echo "SKIPPED_COUNT=${SKIPPED_COUNT}" >> $GITHUB_ENV
          echo "FAIL_COUNT=${FAIL_COUNT}" >> $GITHUB_ENV
          echo "BATCH_MODE=true" >> $GITHUB_ENV

      - name: Check for created PR
        if: inputs.dry_run != true && success()
        env:
          GITHUB_TOKEN: ${{ needs.generate-token.outputs.token }}
        run: |
          echo "=== Checking for newly created PRs ==="
          # List recent PRs
          gh pr list \
            --repo daquinteroflex/copybara-demo-A \
            --limit 5 \
            --state open \
            --search "copybara-import" \
            --json number,title,headRefName,createdAt

      - name: Output Summary
        if: always()
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          DRY_RUN: ${{ inputs.dry_run }}
          BATCH_MODE: ${{ env.BATCH_MODE }}
          SUCCESS_COUNT: ${{ env.SUCCESS_COUNT }}
          SKIPPED_COUNT: ${{ env.SKIPPED_COUNT }}
          FAIL_COUNT: ${{ env.FAIL_COUNT }}
        run: |
          echo "### Copybara PR Import Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${DRY_RUN}" = "true" ]; then
            echo "**Mode:** ðŸ” DRY RUN (preview only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** âœ… LIVE RUN" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${PR_NUMBER}" ]; then
            echo "- **Source:** copybara-demo-B PR #${PR_NUMBER}" >> $GITHUB_STEP_SUMMARY
            echo "- **Action:** Import specific PR" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Source:** copybara-demo-B (all open PRs)" >> $GITHUB_STEP_SUMMARY
            echo "- **Action:** Batch import of all ready PRs" >> $GITHUB_STEP_SUMMARY

            # Show batch results if available
            if [ "${BATCH_MODE}" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### Batch Import Results ðŸ“Š" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… Imported: ${SUCCESS_COUNT:-0}" >> $GITHUB_STEP_SUMMARY
              echo "- â­ï¸  Skipped: ${SKIPPED_COUNT:-0}" >> $GITHUB_STEP_SUMMARY
              echo "- âŒ Failed: ${FAIL_COUNT:-0}" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Destination:** copybara-demo-A/public/test_repo/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${DRY_RUN}" != "true" ]; then
            echo "#### What to check:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… PR created in copybara-demo-A" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Changes are in public/test_repo/ directory" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… No private/ files leaked" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Original PR metadata preserved" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Tests pass" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[View PRs in demo-A â†’](https://github.com/daquinteroflex/copybara-demo-A/pulls)" >> $GITHUB_STEP_SUMMARY
          else
            echo "This was a dry run. No changes were made." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "### âŒ Copybara PR Import Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The import process failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Common issues:" >> $GITHUB_STEP_SUMMARY
          echo "- PR may not exist in demo-B" >> $GITHUB_STEP_SUMMARY
          echo "- PR may be closed (only OPEN PRs are imported)" >> $GITHUB_STEP_SUMMARY
          echo "- Authentication issues with GitHub token" >> $GITHUB_STEP_SUMMARY
          echo "- Merge conflicts in destination repo" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration syntax errors in copy.bara.sky" >> $GITHUB_STEP_SUMMARY
