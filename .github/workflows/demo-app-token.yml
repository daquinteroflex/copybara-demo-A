name: Demo - Create GitHub App Token via API

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  create-token:
    runs-on: ubuntu-latest
    steps:
      - name: Create Installation Access Token
        env:
          APP_ID: ${{ vars.COPYBARA_APP_ID }}
          PRIVATE_KEY: ${{ secrets.COPYBARA_APP_PRIVATE_KEY }}
          INSTALLATION_ID: "104071824"
        run: |
          echo "### Creating GitHub App Installation Token" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Install jwt-cli for creating JWT
          wget -q https://github.com/mike-engel/jwt-cli/releases/download/6.0.0/jwt-linux.tar.gz
          tar -xzf jwt-linux.tar.gz
          chmod +x jwt

          # Create JWT (valid for 10 minutes)
          NOW=$(date +%s)
          IAT=$((NOW - 60))
          EXP=$((NOW + 600))

          # Save private key to file
          echo "$PRIVATE_KEY" > /tmp/private_key.pem

          # Generate JWT
          JWT=$(./jwt encode \
            --alg RS256 \
            --iss "$APP_ID" \
            --exp "$EXP" \
            --iat "$IAT" \
            --secret @/tmp/private_key.pem)

          echo "✅ JWT created (expires in 10 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Create installation access token using gh api
          echo "#### Creating installation access token..." >> $GITHUB_STEP_SUMMARY

          RESPONSE=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $JWT" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /app/installations/${INSTALLATION_ID}/access_tokens \
            --input - <<< '{
              "repositories": ["copybara-demo-A", "copybara-demo-B"],
              "permissions": {
                "contents": "read",
                "metadata": "read"
              }
            }')

          # Extract token and expiration
          TOKEN=$(echo "$RESPONSE" | jq -r '.token')
          EXPIRES_AT=$(echo "$RESPONSE" | jq -r '.expires_at')

          if [ "$TOKEN" != "null" ] && [ -n "$TOKEN" ]; then
            echo "✅ **Installation token created successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Installation ID:** $INSTALLATION_ID" >> $GITHUB_STEP_SUMMARY
            echo "- **Expires at:** $EXPIRES_AT" >> $GITHUB_STEP_SUMMARY
            echo "- **Repositories:** copybara-demo-A, copybara-demo-B" >> $GITHUB_STEP_SUMMARY
            echo "- **Permissions:** contents:read, metadata:read" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Test the token
            echo "#### Testing Token" >> $GITHUB_STEP_SUMMARY
            TEST_RESPONSE=$(gh api \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              /repos/daquinteroflex/copybara-demo-A \
              --jq '{name: .name, private: .private, default_branch: .default_branch}')

            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$TEST_RESPONSE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ Token successfully accessed copybara-demo-A repository" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Failed to create token**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$RESPONSE" | jq >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Cleanup
          rm -f /tmp/private_key.pem

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Token expires after 1 hour and is automatically masked in logs" >> $GITHUB_STEP_SUMMARY
